P16 assembler v1.4.0 (Mar  6 2023)	.\AC_TR4_G09_T24D.lst	Fri Jun 09 16:43:01 2023

Sections
Index   Name            Address   Size
0       startup         0000      000E 14
1       .text           000E      0130 304
2       .data           013E      0000 0
3       .bss            013E      0004 4
4       .stack          0142      0040 64

Symbols
Name                    Type      Value       Section
_start                  LABEL     0004 4      startup
check_USER              LABEL     0020 32     .text
CPSR_BIT_I              ABSOLUTE  0010 16     startup
delay                   LABEL     0126 294    .text
delay_end               LABEL     0130 304    .text
delay_loop              LABEL     012A 298    .text
delay_time              LABEL     002A 42     .text
fix_result              LABEL     0068 104    .text
init                    LABEL     0012 18     .text
INITIAL_OUTPORT         ABSOLUTE  00FF 255    startup
INITIAL_USER            ABSOLUTE  0000 0      startup
inport_addr             LABEL     00D2 210    .text
INPORT_ADDRESS          ABSOLUTE  FF80 65408  startup
inport_read             LABEL     00C4 196    .text
isr                     LABEL     010A 266    .text
isr_addr                LABEL     000C 12     startup
main                    LABEL     000E 14     .text
main_addr               LABEL     000A 10     startup
negative                LABEL     007E 126    .text
out_of_range            LABEL     00A6 166    .text
outport_addr            LABEL     00D0 208    .text
OUTPORT_ADDRESS         ABSOLUTE  FFC0 65472  startup
outport_img             LABEL     0140 320    .bss
outport_img_addr        LABEL     00C2 194    .text
outport_init            LABEL     00B8 184    .text
outport_write           LABEL     00CA 202    .text
positive                LABEL     0092 146    .text
PTC_ADDR                LABEL     013C 316    .text
ptc_addr_addr           LABEL     00D4 212    .text
PTC_ADDRESS             ABSOLUTE  FF78 65400  startup
PTC_CMD_START           ABSOLUTE  0000 0      startup
PTC_CMD_STOP            ABSOLUTE  0001 1      startup
ptc_init                LABEL     00EE 238    .text
ptc_start               LABEL     00D6 214    .text
ptc_stop                LABEL     00E2 226    .text
PTC_TC                  ABSOLUTE  0004 4      startup
PTC_TCR                 ABSOLUTE  0000 0      startup
PTC_TIR                 ABSOLUTE  0006 6      startup
PTC_TMR                 ABSOLUTE  0002 2      startup
reset                   LABEL     0132 306    .text
STACK_SIZE              ABSOLUTE  0040 64     startup
sysclk                  LABEL     013E 318    .bss
sysclk_addr             LABEL     013A 314    .text
SYSCLK_FREQ             ABSOLUTE  00F9 249    startup
sysclk_get_ticks        LABEL     0120 288    .text
time_measure            LABEL     005C 92     .text
tos                     LABEL     0182 386    .stack
tos_addr                LABEL     0008 8      startup
USER_MASk               ABSOLUTE  0001 1      startup

Code listing
   1          	    .equ INITIAL_OUTPORT, 0xFF
   2          	    .equ INITIAL_USER, 0x00
   3          	    .equ USER_MASk, 0x01
   4          	    .equ INPORT_ADDRESS, 0xFF80
   5          	    .equ OUTPORT_ADDRESS, 0xFFC0
   6          		.equ PTC_ADDRESS,  0xFF78          ; Endereco do circuito pTC
   7           	
   8          	    .equ PTC_TCR, 0                    ; Deslocamento do registo TCR do pTC
   9          		.equ PTC_TMR, 2                    ; Deslocamento do registo TMR do pTC
  10          		.equ PTC_TC,  4                    ; Deslocamento do registo TC do pTC
  11          		.equ PTC_TIR, 6                    ; Deslocamento do registo TIR do pTC
  12          		.equ PTC_CMD_START, 0              ; Comando para iniciar a contagem no pTC
  13          		.equ PTC_CMD_STOP, 1               ; Comando para parar a contagem no pTC
  14           	
  15          		.equ SYSCLK_FREQ, 249             ; Intervalo de contagem do circuito pTC
  16           	                                       ; que suporta a implementação do sysclk                          
  17          	    .equ STACK_SIZE, 64                ; Dimensao do stack - 64 B
  18          	    .equ	CPSR_BIT_I, 0b010000         
  19           	;----------------------------------------------------------------------------
  20           	
  21           		.section startup
  22 0000 01 58		b	_start
  23 0002 4F 0C		ldr	pc, isr_addr
  24           	_start:
  25 0004 1D 0C		ldr	sp, tos_addr
  26 0006 1F 0C		ldr	pc, main_addr
  27           	
  28           	tos_addr:
  29 0008 82 01		.word	tos
  30           	main_addr:
  31 000A 0E 00		.word	main
  32           	isr_addr:
  33 000C 0A 01		.word	isr
  34           	
  35           	;---------------------------------------------------------------------------
  36           		.text
  37           	
  38           	main:
  39 000E 91 5C	    bl reset
  40 0010 00 58		b init
  41           	
  42           	;r1 temp
  43           	init:
  44 0012 F0 6F	    mov r0, #INITIAL_OUTPORT
  45 0014 5A 5C	    bl outport_write
  46 0016 56 5C	    bl inport_read
  47 0018 11 60	    mov r1, #USER_MASk
  48 001A 80 C0	    and r0, r0, r1
  49 001C 80 B8	    cmp r0,r1 
  50 001E F9 43	    beq init ;1 bloco
  51           	
  52           	
  53           	check_USER:
  54 0020 51 5C	    bl inport_read 
  55 0022 11 60	    mov r1, #USER_MASk
  56 0024 80 C0	    and r0, r0, r1
  57 0026 80 B8	    cmp r0, r1 ;2 bloco
  58 0028 FB 47	    bne check_USER;transiçao para o terceiro
  59           	
  60           	;r2 Delay Time
  61           	delay_time:
  62 002A 10 60	    mov r0, #0x01
  63 002C 4E 5C	    bl outport_write
  64 002E 4A 5C	    bl inport_read 
  65 0030 00 EA	    lsr r0 , r0 , #4 
  66 0032 11 60	    mov r1 , #0x01
  67 0034 80 B8	    cmp r0 , r1
  68 0036 ED 4B	    blo init 
  69 0038 A1 60	    mov r1 , #0x0A
  70 003A 10 B8	    cmp r1, r0
  71 003C EA 4B	    blo init;3 bloco
  72           	
  73 003E 00 24	    push r0
  74 0040 90 6F	    mov r0, #SYSCLK_FREQ
  75 0042 55 5C	    bl ptc_init
  76 0044 60 B0	    mrs	r0, cpsr
  77 0046 01 61		mov	r1, #CPSR_BIT_I
  78 0048 80 C8		orr	r0, r0, r1
  79 004A 40 B0		msr	cpsr, r0
  80 004C 00 04	    pop r0
  81 004E 6B 5C	    bl delay
  82 0050 00 60	    mov r0, #0x00
  83 0052 3B 5C	    bl outport_write
  84 0054 46 5C	    bl ptc_stop
  85 0056 6D 5C	    bl reset
  86 0058 10 60	    mov r0, #1  ;tempo de execuçao do p16 das funçoes "time_measure" + "isr"
  87 005A 49 5C	    bl ptc_init
  88           	
  89           	time_measure:
  90 005C 33 5C	    bl inport_read
  91 005E 11 60	    mov r1, #0x01
  92 0060 80 C0	    and r0, r0 , r1
  93 0062 80 B8	    cmp r0, r1
  94 0064 FB 43	    beq time_measure
  95 0066 3D 5C	    bl ptc_stop
  96           	
  97           	fix_result:
  98 0068 5B 5C	    bl sysclk_get_ticks
  99 006A 91 68	    mov r1, #0x89 ; 137 ms
 100 006C 10 B8	    cmp r1, r0
 101 006E 1B 50	    bge out_of_range
 102 0070 71 60	    mov r1, #0x07 
 103 0072 11 70	    movt r1, #0x01; 263 ms
 104 0074 80 B8	    cmp r0, r1
 105 0076 17 50	    bge out_of_range
 106 0078 81 6C	    mov r1, #0xC8 ; 200 ms
 107 007A 80 B8	    cmp r0, r1
 108 007C 0A 50	    bge positive
 109           	
 110           	negative:
 111 007E 80 88	    sub r0, r0, r1
 112 0080 80 E0	    lsl r0, r0, #1 ;para colocar o1..o7
 113 0082 23 5C	    bl outport_write
 114 0084 2E 5C	    bl ptc_stop
 115 0086 55 5C	    bl reset
 116 0088 90 6F	    mov r0, #SYSCLK_FREQ
 117 008A 31 5C	    bl ptc_init
 118 008C 50 60	    mov r0, #5
 119 008E 4B 5C	    bl delay
 120 0090 C0 5B	    b init
 121           	
 122           	positive:
 123 0092 80 88	    sub r0, r0 , r1
 124 0094 80 E0	    lsl r0, r0, #1 ;para colocar o1..o7
 125 0096 19 5C	    bl outport_write
 126 0098 24 5C	    bl ptc_stop
 127 009A 4B 5C	    bl reset
 128 009C 90 6F	    mov r0, #SYSCLK_FREQ
 129 009E 27 5C	    bl ptc_init
 130 00A0 50 60	    mov r0, #5 
 131 00A2 41 5C	    bl delay
 132 00A4 B6 5B	    b init
 133           	
 134           	out_of_range:
 135 00A6 00 68	    mov r0, #0x80
 136 00A8 10 5C	    bl outport_write
 137 00AA 1B 5C	    bl ptc_stop
 138 00AC 42 5C	    bl reset
 139 00AE 90 6F	    mov r0, #SYSCLK_FREQ
 140 00B0 1E 5C	    bl ptc_init
 141 00B2 50 60	    mov r0, #5
 142 00B4 38 5C	    bl delay
 143 00B6 AD 5B	    b init
 144           	
 145           	
 146           	
 147           	outport_init:
 148 00B8 0E 24		push	lr
 149 00BA 31 0C		ldr	r1, outport_img_addr
 150 00BC 10 28		strb	r0, [r1]
 151 00BE 05 5C		bl	outport_write
 152 00C0 0F 04		pop	pc
 153           	
 154           	outport_img_addr:
 155 00C2 40 01		.word	outport_img
 156           	
 157           	inport_read:
 158 00C4 61 0C		ldr	r1, inport_addr
 159 00C6 10 08		ldrb	r0, [r1, #0]
 160 00C8 0F B7		mov	pc, lr
 161           	
 162           	    
 163           	outport_write:
 164 00CA 21 0C		ldr	r1, outport_addr
 165 00CC 10 28		strb	r0, [r1, #0]
 166 00CE 0F B7		mov	pc, lr
 167           	
 168           	outport_addr:
 169 00D0 C0 FF	    .word OUTPORT_ADDRESS
 170           	
 171           	
 172           	inport_addr:
 173 00D2 80 FF	    .word INPORT_ADDRESS
 174           	
 175           	ptc_addr_addr:
 176 00D4 3C 01	    .word PTC_ADDR
 177           	
 178           	
 179           	
 180           	ptc_start:
 181 00D6 00 24	    push r0
 182 00D8 10 0F		ldr	r0, PTC_ADDR
 183 00DA 01 60		mov	r1, #PTC_CMD_START
 184 00DC 01 28		strb r1, [r0, #PTC_TCR]
 185 00DE 00 04	    pop r0
 186 00E0 0F B7		mov	pc, lr
 187           	
 188           	ptc_stop:
 189 00E2 00 24	    push r0
 190 00E4 B0 0E		ldr	r0, PTC_ADDR
 191 00E6 11 60		mov	r1, #PTC_CMD_STOP
 192 00E8 01 28		strb r1, [r0, #PTC_TCR]
 193 00EA 00 04	    pop r0
 194 00EC 0F B7		mov	pc, lr
 195           	
 196           	ptc_init:
 197 00EE 0E 24		push lr
 198 00F0 00 24	    push r0
 199 00F2 04 24	    push r4
 200 00F4 05 24		push r5
 201 00F6 05 B0		mov r5, r0
 202 00F8 F4 5F	    bl ptc_stop
 203 00FA 04 0E		ldr r4, PTC_ADDR
 204 00FC 45 29		strb r5, [r4, #PTC_TMR]
 205 00FE 45 2B	    strb     r5, [r4, #PTC_TIR] ; limpar PTC TIR
 206 0100 EA 5F	    bl ptc_start
 207 0102 05 04		pop r5
 208 0104 04 04		pop r4
 209 0106 00 04	    pop r0
 210 0108 0F 04	    pop pc
 211           	
 212           	isr:
 213 010A 00 24	 	push    r0
 214 010C 01 24	    push    r1
 215           	    ; limpar PTC TIR
 216 010E 60 0D	    ldr r0, PTC_ADDR
 217 0110 00 2B	    strb r0, [r0, #PTC_TIR]
 218 0112 30 0D	    ldr    r0, sysclk_addr
 219 0114 01 00	    ldr    r1, [r0, #0]
 220 0116 91 A0	    add    r1, r1, #1
 221 0118 01 20	    str    r1, [r0, #0]
 222 011A 01 04	    pop    r1
 223 011C 00 04	    pop    r0
 224 011E 20 B0	    movs    pc, lr
 225           	
 226           	sysclk_get_ticks:
 227 0120 C0 0C		ldr    r0, sysclk_addr
 228 0122 00 00	    ldr    r0, [r0, #0]
 229 0124 0F B7	    mov    pc, lr
 230           	
 231           	delay:
 232 0126 0E 24	    push lr
 233 0128 01 E1	    lsl r1, r0, #2
 234           	delay_loop:
 235 012A FA 5F	   bl sysclk_get_ticks
 236 012C 10 B8	   cmp r1, r0
 237 012E FD 47	   bne delay_loop
 238           	delay_end:
 239 0130 0F 04	    pop pc
 240           	
 241           	
 242           	reset:
 243 0132 31 0C	    ldr r1, sysclk_addr
 244 0134 02 60	    mov r2, #0
 245 0136 12 20	    str r2,[r1]
 246 0138 0F B7	    mov pc, lr
 247           	
 248           	sysclk_addr:
 249 013A 3E 01	    .word sysclk
 250           	
 251           	PTC_ADDR:
 252 013C 78 FF	    .word    PTC_ADDRESS
 253           	
 254           	
 255           	;----------------------------------------------------------------------------
 256           	
 257           	    .data
 258           	
 259           	;----------------------------------------------------------------------------    
 260           	
 261           	    .bss
 262           	sysclk:
 263 013E 00   		.space	2
 263 013F 00
 264           	outport_img:
 265 0140 00   		.space	1
 266 0141 00  		.align
 267           	;----------------------------------------------------------------------------
 268           	
 269           	    .stack
 270 0142 00   	    .space STACK_SIZE
 270 .... ..
 270 0181 00
 271           	tos:
