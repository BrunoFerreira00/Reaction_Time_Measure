P16 assembler v1.4.0 (Mar  6 2023)	AC_TR4_G09_T24D.lst	Wed Jun 07 11:20:03 2023

Sections
Index   Name            Address   Size
0       startup         0000      000E 14
1       .text           000E      0130 304
2       .data           013E      0000 0
3       .bss            013E      0004 4
4       .stack          0142      0040 64

Symbols
Name                    Type      Value       Section
_start                  LABEL     0004 4      startup
check_USER              LABEL     002A 42     .text
CPSR_BIT_I              ABSOLUTE  0010 16     startup
delay                   LABEL     0122 290    .text
delay_end               LABEL     0136 310    .text
delay_loop              LABEL     012A 298    .text
delay_time              LABEL     0030 48     .text
fix_result              LABEL     0074 116    .text
init                    LABEL     001E 30     .text
INITIAL_OUTPORT         ABSOLUTE  00FF 255    startup
INITIAL_USER            ABSOLUTE  0000 0      startup
inport_addr             LABEL     00CC 204    .text
INPORT_ADDRESS          ABSOLUTE  FF80 65408  startup
inport_read             LABEL     00BE 190    .text
isr                     LABEL     0104 260    .text
isr_addr                LABEL     000C 12     startup
main                    LABEL     000E 14     .text
main_addr               LABEL     000A 10     startup
multiplication          LABEL     004C 76     .text
negative                LABEL     0088 136    .text
out_of_range            LABEL     00A6 166    .text
outport_addr            LABEL     00CA 202    .text
OUTPORT_ADDRESS         ABSOLUTE  FFC0 65472  startup
outport_img             LABEL     0140 320    .bss
outport_img_addr        LABEL     00BC 188    .text
outport_init            LABEL     00B2 178    .text
outport_write           LABEL     00C4 196    .text
positive                LABEL     0098 152    .text
PTC_ADDR                LABEL     013C 316    .text
ptc_addr_addr           LABEL     00CE 206    .text
PTC_ADDRESS             ABSOLUTE  FF78 65400  startup
PTC_CMD_START           ABSOLUTE  0000 0      startup
PTC_CMD_STOP            ABSOLUTE  0001 1      startup
ptc_init                LABEL     00E8 232    .text
ptc_start               LABEL     00D0 208    .text
ptc_stop                LABEL     00DC 220    .text
PTC_TC                  ABSOLUTE  0004 4      startup
PTC_TCR                 ABSOLUTE  0000 0      startup
PTC_TIR                 ABSOLUTE  0006 6      startup
PTC_TMR                 ABSOLUTE  0002 2      startup
restart                 LABEL     0138 312    .text
STACK_SIZE              ABSOLUTE  0040 64     startup
sysclk                  LABEL     013E 318    .bss
sysclk_addr             LABEL     0120 288    .text
SYSCLK_FREQ             ABSOLUTE  00FA 250    startup
sysclk_get_ticks        LABEL     011A 282    .text
time_measure            LABEL     0066 102    .text
tos                     LABEL     0182 386    .stack
tos_addr                LABEL     0008 8      startup
USER_MASk               ABSOLUTE  0001 1      startup

Code listing
   1          	    .equ INITIAL_OUTPORT, 0xFF
   2          	    .equ INITIAL_USER, 0x00
   3          	    .equ USER_MASk, 0x01
   4          	    .equ INPORT_ADDRESS, 0xFF80
   5          	    .equ OUTPORT_ADDRESS, 0xFFC0
   6          		.equ PTC_ADDRESS,  0xFF78        ; Endereco do circuito pTC
   7           	
   8          	    .equ PTC_TCR, 0                    ; Deslocamento do registo TCR do pTC
   9          		.equ PTC_TMR, 2                    ; Deslocamento do registo TMR do pTC
  10          		.equ PTC_TC,  4                    ; Deslocamento do registo TC do pTC
  11          		.equ PTC_TIR, 6                    ; Deslocamento do registo TIR do pTC
  12          		.equ PTC_CMD_START, 0              ; Comando para iniciar a contagem no pTC
  13          		.equ PTC_CMD_STOP, 1               ; Comando para parar a contagem no pTC
  14           	
  15          		.equ SYSCLK_FREQ, 0xFA             ; Intervalo de contagem do circuito pTC
  16           	                                          ; que suporta a implementação do sysclk                          
  17          	    .equ STACK_SIZE, 64                ; Dimensao do stack - 64 B
  18          	    .equ CPSR_BIT_I, 0b010000          ; Mascara para o bit I do registo CPSR
  19           	;----------------------------------------------------------------------------
  20           	
  21           		.section startup
  22 0000 01 58		b	_start
  23 0002 4F 0C		ldr	pc, isr_addr
  24           	_start:
  25 0004 1D 0C		ldr	sp, tos_addr
  26 0006 1F 0C		ldr	pc, main_addr
  27           	
  28           	tos_addr:
  29 0008 82 01		.word	tos
  30           	main_addr:
  31 000A 0E 00		.word	main
  32           	isr_addr:
  33 000C 04 01		.word	isr
  34           	
  35           	;---------------------------------------------------------------------------
  36           		.text
  37           	
  38           	main:
  39 000E F0 6F		mov	r0, #INITIAL_OUTPORT
  40 0010 50 5C		bl	outport_init
  41 0012 A0 6F		mov	r0, #SYSCLK_FREQ
  42 0014 69 5C		bl	ptc_init
  43 0016 60 B0		mrs	r0, cpsr
  44 0018 01 61		mov	r1, #CPSR_BIT_I
  45 001A 80 C8		orr	r0, r0, r1
  46 001C 40 B0		msr	cpsr, r0
  47           	
  48           	
  49           	;r1 temp
  50           	init:
  51 001E F0 6F	    mov r0, #INITIAL_OUTPORT
  52 0020 51 5C	    bl outport_write
  53 0022 4D 5C	    bl inport_read
  54 0024 01 60	    mov r1, #INITIAL_USER
  55 0026 80 B8	    cmp r0,r1 
  56 0028 FA 47	    bne init ;1 bloco
  57           	
  58           	check_USER:
  59 002A 11 60	    mov r1, #USER_MASk
  60 002C 80 B8	    cmp r0, r1 ;2 bloco
  61 002E FD 47	    bne check_USER;transiçao para o terceiro
  62           	
  63           	;r2 Delay Time
  64           	delay_time:
  65 0030 00 24	    push r0
  66 0032 10 60	    mov r0, #0x01
  67 0034 47 5C	    bl outport_write
  68 0036 43 5C	    bl inport_read
  69 0038 02 B0	    mov r2 , r0
  70 003A 22 EA	    lsr r2 , r2 , #4
  71 003C 11 60	    mov r1 , #0x01
  72 003E 10 B9	    cmp r1 , r2
  73 0040 F7 4F	    bhs delay_time 
  74 0042 A1 60	    mov r1 , #0x0A
  75 0044 A0 B8	    cmp r2, r1
  76 0046 F4 4F	    bhs delay_time;3 bloco
  77 0048 03 60	    mov r3, #0
  78 004A 00 04	    pop r0
  79           	
  80           	multiplication:
  81 004C 00 24	    push r0
  82 004E 33 A2	    add r3, r3, #4
  83 0050 A2 A8	    sub r2, r2, #1
  84 0052 01 60	    mov r1, #0
  85 0054 A0 B8	    cmp r2, r1
  86 0056 FA 47	    bne multiplication
  87 0058 A0 6F	    mov r0, #SYSCLK_FREQ
  88 005A 63 5C	    bl delay
  89 005C 00 04	    pop r0
  90           	
  91           	
  92 005E 03 60	    mov r3, #0
  93 0060 01 60	    mov r1, #0x00
  94 0062 32 0F	    ldr r2 , outport_addr
  95 0064 21 20	    str r1, [r2]
  96           	time_measure:
  97 0066 00 24	    push r0
  98 0068 B3 A0	    add r3, r3, #1
  99 006A 11 60	    mov r1, #0x01
 100 006C 80 C0	    and r0, r0 , r1
 101 006E 80 B8	    cmp r0, r1
 102 0070 FA 43	    beq time_measure
 103 0072 00 04	    pop r0
 104           	
 105           	fix_result:
 106 0074 91 68	    mov r1, #0x89 ; 137 ms
 107 0076 90 B9	    cmp r1, r3
 108 0078 16 4C	    bhs out_of_range
 109 007A 71 60	    mov r1, #0x07 
 110 007C 11 70	    movt r1, #0x01; 263 ms
 111 007E B0 B8	    cmp r3, r1
 112 0080 12 4C	    bhs out_of_range
 113 0082 81 6C	    mov r1, #0xC8 ; 200 ms
 114 0084 B0 B8	    cmp r3, r1
 115 0086 08 50	    bge positive
 116           	
 117           	negative:
 118 0088 B3 88	    sub r3, r3, r1
 119 008A B3 E0	    lsl r3, r3, #1 ;para colocar o1..o7
 120 008C E2 0D	    ldr r2, outport_addr
 121 008E 23 20	    str r3, [r2]
 122 0090 43 61	    mov r3, #20
 123 0092 A0 6F	    mov r0, #SYSCLK_FREQ
 124 0094 46 5C	    bl delay
 125 0096 C3 5B	    b init
 126           	
 127           	positive:
 128 0098 B3 88	    sub r3, r3 , r1
 129 009A B3 E0	    lsl r3, r3, #1 ;para colocar o1..o7
 130 009C 23 20	    str r3, [r2]
 131 009E 43 61	    mov r3, #20
 132 00A0 A0 6F	    mov r0, #SYSCLK_FREQ
 133 00A2 3F 5C	    bl delay
 134 00A4 BC 5B	    b init
 135           	
 136           	out_of_range:
 137 00A6 01 68	    mov r1, #0x80
 138 00A8 21 20	    str r1, [r2]
 139 00AA 43 61	    mov r3, #20
 140 00AC A0 6F	    mov r0, #SYSCLK_FREQ
 141 00AE 39 5C	    bl delay
 142 00B0 B6 5B	    b init
 143           	
 144           	
 145           	
 146           	outport_init:
 147 00B2 0E 24		push	lr
 148 00B4 31 0C		ldr	r1, outport_img_addr
 149 00B6 10 28		strb	r0, [r1]
 150 00B8 05 5C		bl	outport_write
 151 00BA 0F 04		pop	pc
 152           	
 153           	outport_img_addr:
 154 00BC 40 01		.word	outport_img
 155           	
 156           	inport_read:
 157 00BE 61 0C		ldr	r1, inport_addr
 158 00C0 10 08		ldrb	r0, [r1, #0]
 159 00C2 0F B7		mov	pc, lr
 160           	
 161           	    
 162           	outport_write:
 163 00C4 21 0C		ldr	r1, outport_addr
 164 00C6 10 28		strb	r0, [r1, #0]
 165 00C8 0F B7		mov	pc, lr
 166           	
 167           	outport_addr:
 168 00CA C0 FF	    .word OUTPORT_ADDRESS
 169           	
 170           	
 171           	inport_addr:
 172 00CC 80 FF	    .word INPORT_ADDRESS
 173           	
 174           	ptc_addr_addr:
 175 00CE 3C 01	    .word PTC_ADDR
 176           	
 177           	
 178           	
 179           	ptc_start:
 180 00D0 00 24	    push r0
 181 00D2 40 0F		ldr	r0, PTC_ADDR
 182 00D4 01 60		mov	r1, #PTC_CMD_START
 183 00D6 01 28		strb r1, [r0, #PTC_TCR]
 184 00D8 00 04	    pop r0
 185 00DA 0F B7		mov	pc, lr
 186           	
 187           	ptc_stop:
 188 00DC 00 24	    push r0
 189 00DE E0 0E		ldr	r0, PTC_ADDR
 190 00E0 11 60		mov	r1, #PTC_CMD_STOP
 191 00E2 01 28		strb r1, [r0, #PTC_TCR]
 192 00E4 00 04	    pop r0
 193 00E6 0F B7		mov	pc, lr
 194           	
 195           	ptc_init:
 196 00E8 0E 24		push lr
 197 00EA 00 24	    push r0
 198 00EC 04 24	    push r4
 199 00EE 05 24		push r5
 200 00F0 05 B0		mov r5, r0
 201 00F2 F4 5F	    bl ptc_stop
 202 00F4 34 0E		ldr r4, PTC_ADDR
 203 00F6 45 29		strb r5, [r4, #PTC_TMR]
 204 00F8 45 2B	    strb     r5, [r4, #PTC_TIR] ; limpar PTC TIR
 205 00FA EA 5F	    bl ptc_start
 206 00FC 05 04		pop r5
 207 00FE 04 04		pop r4
 208 0100 00 04	    pop r0
 209 0102 0F 04	    pop pc
 210           	
 211           	isr:
 212 0104 00 24	 	push    r0
 213 0106 01 24	    push    r1
 214           	    ; limpar PTC TIR
 215 0108 90 0D	    ldr r0, PTC_ADDR
 216 010A 00 2B	    strb r0, [r0, #PTC_TIR]
 217 010C 90 0C	    ldr    r0, sysclk_addr
 218 010E 01 00	    ldr    r1, [r0, #0]
 219 0110 91 A0	    add    r1, r1, #1
 220 0112 01 20	    str    r1, [r0, #0]
 221 0114 01 04	    pop    r1
 222 0116 00 04	    pop    r0
 223 0118 20 B0	    movs    pc, lr
 224           	
 225           	sysclk_get_ticks:
 226 011A 20 0C		ldr    r0, sysclk_addr
 227 011C 00 00	    ldr    r0, [r0, #0]
 228 011E 0F B7	    mov    pc, lr
 229           	
 230           	sysclk_addr:
 231 0120 3E 01	    .word sysclk
 232           	
 233           	delay:
 234 0122 02 60	    mov r2 , #0
 235 0124 00 C0	    and r0, r0, r0
 236 0126 00 B9	    cmp r0, r2
 237 0128 06 40	    beq delay_end
 238           	delay_loop:
 239 012A 80 A8	    sub r0, r0, #1
 240 012C 00 B9	    cmp r0, r2
 241 012E FD 47	    bne delay_loop
 242 0130 B3 A8	    sub r3, r3, #1
 243 0132 30 B9	    cmp r3, r2
 244 0134 01 44	    bne restart
 245           	delay_end:
 246 0136 0F B7	    mov pc, lr
 247           	
 248           	restart:
 249 0138 A0 6F	    mov r0 , #SYSCLK_FREQ
 250 013A F3 5B	    b delay
 251           	
 252           	
 253           	PTC_ADDR:
 254 013C 78 FF	    .word    PTC_ADDRESS
 255           	
 256           	
 257           	
 258           	
 259           	
 260           	;----------------------------------------------------------------------------
 261           	
 262           	    .data
 263           	
 264           	;----------------------------------------------------------------------------    
 265           	
 266           	    .bss
 267           	sysclk:
 268 013E 00   		.space	2
 268 013F 00
 269           	outport_img:
 270 0140 00   		.space	1
 271 0141 00  		.align
 272           	;----------------------------------------------------------------------------
 273           	
 274           	    .stack
 275 0142 00   	    .space STACK_SIZE
 275 .... ..
 275 0181 00
 276           	tos:
