P16 assembler v1.4.0 (Mar  6 2023)	c:\Users\fbrun\Desktop\Programas_Universidade\2_semestre\arquitetura_computadores\AC_TR4\AC_TR4_G09_T24D.lst	Fri Jun 09 10:58:20 2023

Sections
Index   Name            Address   Size
0       startup         0000      000E 14
1       .text           000E      012C 300
2       .data           013A      0000 0
3       .bss            013A      0004 4
4       .stack          013E      0040 64

Symbols
Name                    Type      Value       Section
_start                  LABEL     0004 4      startup
check_USER              LABEL     002C 44     .text
CPSR_BIT_I              ABSOLUTE  0010 16     startup
delay                   LABEL     011E 286    .text
delay_end               LABEL     0132 306    .text
delay_loop              LABEL     0126 294    .text
delay_time              LABEL     0036 54     .text
fix_result              LABEL     006E 110    .text
init                    LABEL     001E 30     .text
INITIAL_OUTPORT         ABSOLUTE  00FF 255    startup
inport_addr             LABEL     00C8 200    .text
INPORT_ADDRESS          ABSOLUTE  FF80 65408  startup
inport_read             LABEL     00BA 186    .text
isr                     LABEL     0100 256    .text
isr_addr                LABEL     000C 12     startup
main                    LABEL     000E 14     .text
main_addr               LABEL     000A 10     startup
multiplication          LABEL     004E 78     .text
negative                LABEL     0082 130    .text
out_of_range            LABEL     00A2 162    .text
outport_addr            LABEL     00C6 198    .text
OUTPORT_ADDRESS         ABSOLUTE  FFC0 65472  startup
outport_img             LABEL     013C 316    .bss
outport_img_addr        LABEL     00B8 184    .text
outport_init            LABEL     00AE 174    .text
outport_write           LABEL     00C0 192    .text
positive                LABEL     0092 146    .text
PTC_ADDR                LABEL     0138 312    .text
ptc_addr_addr           LABEL     00CA 202    .text
PTC_ADDRESS             ABSOLUTE  FF78 65400  startup
PTC_CMD_START           ABSOLUTE  0000 0      startup
PTC_CMD_STOP            ABSOLUTE  0001 1      startup
ptc_init                LABEL     00E4 228    .text
ptc_start               LABEL     00CC 204    .text
ptc_stop                LABEL     00D8 216    .text
PTC_TC                  ABSOLUTE  0004 4      startup
PTC_TCR                 ABSOLUTE  0000 0      startup
PTC_TIR                 ABSOLUTE  0006 6      startup
PTC_TMR                 ABSOLUTE  0002 2      startup
restart                 LABEL     0134 308    .text
STACK_SIZE              ABSOLUTE  0040 64     startup
sysclk                  LABEL     013A 314    .bss
sysclk_addr             LABEL     011C 284    .text
SYSCLK_FREQ             ABSOLUTE  00FA 250    startup
sysclk_get_ticks        LABEL     0116 278    .text
time_measure            LABEL     0062 98     .text
tos                     LABEL     017E 382    .stack
tos_addr                LABEL     0008 8      startup
USER_MASk               ABSOLUTE  0001 1      startup

Code listing
   1          	    .equ INITIAL_OUTPORT, 0xFF
   2          	    .equ USER_MASk, 0x01
   3          	    .equ INPORT_ADDRESS, 0xFF80
   4          	    .equ OUTPORT_ADDRESS, 0xFFC0
   5          		.equ PTC_ADDRESS,  0xFF78        ; Endereco do circuito pTC
   6           	
   7          	    .equ PTC_TCR, 0                    ; Deslocamento do registo TCR do pTC
   8          		.equ PTC_TMR, 2                    ; Deslocamento do registo TMR do pTC
   9          		.equ PTC_TC,  4                    ; Deslocamento do registo TC do pTC
  10          		.equ PTC_TIR, 6                    ; Deslocamento do registo TIR do pTC
  11          		.equ PTC_CMD_START, 0              ; Comando para iniciar a contagem no pTC
  12          		.equ PTC_CMD_STOP, 1               ; Comando para parar a contagem no pTC
  13           	
  14          		.equ SYSCLK_FREQ, 0xFA             ; Intervalo de contagem do circuito pTC
  15           	                                          ; que suporta a implementação do sysclk                          
  16          	    .equ STACK_SIZE, 64                ; Dimensao do stack - 64 B
  17          	    .equ CPSR_BIT_I, 0b010000          ; Mascara para o bit I do registo CPSR
  18           	;----------------------------------------------------------------------------
  19           	
  20           		.section startup
  21 0000 01 58		b	_start
  22 0002 4F 0C		ldr	pc, isr_addr
  23           	_start:
  24 0004 1D 0C		ldr	sp, tos_addr
  25 0006 1F 0C		ldr	pc, main_addr
  26           	
  27           	tos_addr:
  28 0008 7E 01		.word	tos
  29           	main_addr:
  30 000A 0E 00		.word	main
  31           	isr_addr:
  32 000C 00 01		.word	isr
  33           	
  34           	;---------------------------------------------------------------------------
  35           		.text
  36           	
  37           	main:
  38 000E F0 6F		mov	r0, #INITIAL_OUTPORT
  39 0010 4E 5C		bl	outport_init
  40 0012 A0 6F		mov	r0, #SYSCLK_FREQ
  41 0014 67 5C		bl	ptc_init
  42 0016 60 B0		mrs	r0, cpsr
  43 0018 01 61		mov	r1, #CPSR_BIT_I
  44 001A 80 C8		orr	r0, r0, r1
  45 001C 40 B0		msr	cpsr, r0
  46           	
  47           	
  48           	;r1 temp
  49           	init:
  50 001E F0 6F	    mov r0, #INITIAL_OUTPORT
  51 0020 4F 5C	    bl outport_write
  52 0022 4B 5C	    bl inport_read
  53 0024 11 60	    mov r1, #USER_MASk
  54 0026 80 C0	    and r0, r0, r1
  55 0028 80 B8	    cmp r0,r1 
  56 002A F9 43	    beq init ;1 bloco
  57           	
  58           	check_USER:
  59 002C 46 5C	    bl inport_read
  60 002E 11 60	    mov r1, #USER_MASk
  61 0030 80 C0	    and r0, r0, r1
  62 0032 80 B8	    cmp r0, r1 ;2 bloco
  63 0034 FB 47	    bne check_USER ;transiçao para o terceiro
  64           	
  65           	
  66           	;r2 Delay Time
  67           	delay_time:
  68 0036 10 60	    mov r0, #0x01
  69 0038 43 5C	    bl outport_write
  70 003A 3F 5C	    bl inport_read
  71 003C 02 B0	    mov r2 , r0
  72 003E 22 EA	    lsr r2 , r2 , #4
  73 0040 01 60	    mov r1 , #0x00
  74 0042 10 B9	    cmp r1 , r2
  75 0044 EC 4F	    bhs init
  76 0046 B1 60	    mov r1 , #0x0B
  77 0048 A0 B8	    cmp r2, r1
  78 004A E9 4F	    bhs init;3 bloco
  79 004C 03 60	    mov r3, #0
  80           	
  81           	multiplication:
  82 004E 33 A2	    add r3, r3, #4
  83 0050 A2 A8	    sub r2, r2, #1
  84 0052 01 60	    mov r1, #0
  85 0054 A0 B8	    cmp r2, r1
  86 0056 FB 47	    bne multiplication
  87 0058 A0 6F	    mov r0, #SYSCLK_FREQ
  88 005A 61 5C	    bl delay
  89 005C 03 60	    mov r3, #0
  90 005E 00 60	    mov r0, #0x00
  91 0060 2F 5C	    bl outport_write
  92           	
  93           	time_measure:
  94 0062 2B 5C	    bl inport_read 
  95 0064 B3 A0	    add r3, r3, #1
  96 0066 11 60	    mov r1, #0x01
  97 0068 80 C0	    and r0, r0 , r1
  98 006A 80 B8	    cmp r0, r1
  99 006C FA 43	    beq time_measure
 100           	
 101           	fix_result:
 102 006E 91 68	    mov r1, #0x89 ; 137 ms
 103 0070 90 B9	    cmp r1, r3
 104 0072 17 4C	    bhs out_of_range
 105 0074 71 60	    mov r1, #0x07 
 106 0076 11 70	    movt r1, #0x01; 263 ms
 107 0078 B0 B8	    cmp r3, r1
 108 007A 13 4C	    bhs out_of_range
 109 007C 81 6C	    mov r1, #0xC8 ; 200 ms
 110 007E B0 B8	    cmp r3, r1
 111 0080 08 50	    bge positive
 112           	
 113           	negative:
 114 0082 B3 88	    sub r3, r3, r1
 115 0084 B3 E0	    lsl r3, r3, #1 ;para colocar o1..o7
 116 0086 80 B1	    mov r0, r3
 117 0088 1B 5C	    bl outport_write
 118 008A 43 61	    mov r3, #20
 119 008C A0 6F	    mov r0, #SYSCLK_FREQ
 120 008E 47 5C	    bl delay
 121 0090 C6 5B	    b init
 122           	
 123           	positive:
 124 0092 B3 88	    sub r3, r3 , r1
 125 0094 B3 E0	    lsl r3, r3, #1 ;para colocar o1..o7
 126 0096 80 B1	    mov r0, r3
 127 0098 13 5C	    bl outport_write
 128 009A 43 61	    mov r3, #20
 129 009C A0 6F	    mov r0, #SYSCLK_FREQ
 130 009E 3F 5C	    bl delay
 131 00A0 BE 5B	    b init
 132           	
 133           	out_of_range:
 134 00A2 00 68	    mov r0, #0x80
 135 00A4 0D 5C	    bl outport_write
 136 00A6 43 61	    mov r3, #20
 137 00A8 A0 6F	    mov r0, #SYSCLK_FREQ
 138 00AA 39 5C	    bl delay
 139 00AC B8 5B	    b init
 140           	
 141           	
 142           	
 143           	outport_init:
 144 00AE 0E 24		push	lr
 145 00B0 31 0C		ldr	r1, outport_img_addr
 146 00B2 10 28		strb	r0, [r1]
 147 00B4 05 5C		bl	outport_write
 148 00B6 0F 04		pop	pc
 149           	
 150           	outport_img_addr:
 151 00B8 3C 01		.word	outport_img
 152           	
 153           	inport_read:
 154 00BA 61 0C		ldr	r1, inport_addr
 155 00BC 10 08		ldrb r0, [r1, #0]
 156 00BE 0F B7		mov	pc, lr
 157           	
 158           	    
 159           	outport_write:
 160 00C0 21 0C		ldr	r1, outport_addr
 161 00C2 10 28		strb r0, [r1, #0]
 162 00C4 0F B7		mov	pc, lr
 163           	
 164           	outport_addr:
 165 00C6 C0 FF	    .word OUTPORT_ADDRESS
 166           	
 167           	
 168           	inport_addr:
 169 00C8 80 FF	    .word INPORT_ADDRESS
 170           	
 171           	ptc_addr_addr:
 172 00CA 38 01	    .word PTC_ADDR
 173           	
 174           	
 175           	
 176           	ptc_start:
 177 00CC 00 24	    push r0
 178 00CE 40 0F		ldr	r0, PTC_ADDR
 179 00D0 01 60		mov	r1, #PTC_CMD_START
 180 00D2 01 28		strb r1, [r0, #PTC_TCR]
 181 00D4 00 04	    pop r0
 182 00D6 0F B7		mov	pc, lr
 183           	
 184           	ptc_stop:
 185 00D8 00 24	    push r0
 186 00DA E0 0E		ldr	r0, PTC_ADDR
 187 00DC 11 60		mov	r1, #PTC_CMD_STOP
 188 00DE 01 28		strb r1, [r0, #PTC_TCR]
 189 00E0 00 04	    pop r0
 190 00E2 0F B7		mov	pc, lr
 191           	
 192           	ptc_init:
 193 00E4 0E 24		push lr
 194 00E6 00 24	    push r0
 195 00E8 04 24	    push r4
 196 00EA 05 24		push r5
 197 00EC 05 B0		mov r5, r0
 198 00EE F4 5F	    bl ptc_stop
 199 00F0 34 0E		ldr r4, PTC_ADDR
 200 00F2 45 29		strb r5, [r4, #PTC_TMR]
 201 00F4 45 2B	    strb     r5, [r4, #PTC_TIR] ; limpar PTC TIR
 202 00F6 EA 5F	    bl ptc_start
 203 00F8 05 04		pop r5
 204 00FA 04 04		pop r4
 205 00FC 00 04	    pop r0
 206 00FE 0F 04	    pop pc
 207           	
 208           	isr:
 209 0100 00 24	 	push    r0
 210 0102 01 24	    push    r1
 211           	    ; limpar PTC TIR
 212 0104 90 0D	    ldr r0, PTC_ADDR
 213 0106 00 2B	    strb r0, [r0, #PTC_TIR]
 214 0108 90 0C	    ldr    r0, sysclk_addr
 215 010A 01 00	    ldr    r1, [r0, #0]
 216 010C 91 A0	    add    r1, r1, #1
 217 010E 01 20	    str    r1, [r0, #0]
 218 0110 01 04	    pop    r1
 219 0112 00 04	    pop    r0
 220 0114 20 B0	    movs    pc, lr
 221           	
 222           	sysclk_get_ticks:
 223 0116 20 0C		ldr    r0, sysclk_addr
 224 0118 00 00	    ldr    r0, [r0, #0]
 225 011A 0F B7	    mov    pc, lr
 226           	
 227           	sysclk_addr:
 228 011C 3A 01	    .word sysclk
 229           	
 230           	delay:
 231 011E 02 60	    mov r2 , #0
 232 0120 00 C0	    and r0, r0, r0
 233 0122 00 B9	    cmp r0, r2
 234 0124 06 40	    beq delay_end
 235           	delay_loop:
 236 0126 80 A8	    sub r0, r0, #1
 237 0128 00 B9	    cmp r0, r2
 238 012A FD 47	    bne delay_loop
 239 012C B3 A8	    sub r3, r3, #1
 240 012E 30 B9	    cmp r3, r2
 241 0130 01 44	    bne restart
 242           	delay_end:
 243 0132 0F B7	    mov pc, lr
 244           	
 245           	restart:
 246 0134 A0 6F	    mov r0 , #SYSCLK_FREQ
 247 0136 F3 5B	    b delay
 248           	
 249           	
 250           	PTC_ADDR:
 251 0138 78 FF	    .word    PTC_ADDRESS
 252           	
 253           	
 254           	
 255           	
 256           	
 257           	;----------------------------------------------------------------------------
 258           	
 259           	    .data
 260           	
 261           	;----------------------------------------------------------------------------    
 262           	
 263           	    .bss
 264           	sysclk:
 265 013A 00   		.space	2
 265 013B 00
 266           	outport_img:
 267 013C 00   		.space	1
 268 013D 00  		.align
 269           	;----------------------------------------------------------------------------
 270           	
 271           	    .stack
 272 013E 00   	    .space STACK_SIZE
 272 .... ..
 272 017D 00
 273           	tos:
