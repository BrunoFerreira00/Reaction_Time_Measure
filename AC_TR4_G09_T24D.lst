P16 assembler v1.4.0 (Mar  6 2023)	.\AC_TR4_G09_T24D.lst	Fri Jun 09 19:15:05 2023

Sections
Index   Name            Address   Size
0       startup         0000      000E 14
1       .text           000E      0156 342
2       .data           0164      0000 0
3       .bss            0164      0004 4
4       .stack          0168      0040 64

Symbols
Name                    Type      Value       Section
_start                  LABEL     0004 4      startup
check_USER              LABEL     0020 32     .text
CPSR_BIT_I              ABSOLUTE  0010 16     startup
delay_after             LABEL     0136 310    .text
delay_before            LABEL     0128 296    .text
delay_end_after         LABEL     0140 320    .text
delay_end_before        LABEL     0134 308    .text
delay_loop_after        LABEL     013A 314    .text
delay_loop_before       LABEL     012C 300    .text
delay_time              LABEL     002A 42     .text
fix_result              LABEL     006A 106    .text
init                    LABEL     0010 16     .text
INITIAL_OUTPORT         ABSOLUTE  00FF 255    startup
INITIAL_USER            ABSOLUTE  0000 0      startup
inport_addr             LABEL     00D4 212    .text
INPORT_ADDRESS          ABSOLUTE  FF80 65408  startup
inport_read             LABEL     00C6 198    .text
isr                     LABEL     010C 268    .text
isr_addr                LABEL     000C 12     startup
main                    LABEL     000E 14     .text
main_addr               LABEL     000A 10     startup
negative                LABEL     0080 128    .text
out_of_range            LABEL     00A8 168    .text
outport_addr            LABEL     00D2 210    .text
OUTPORT_ADDRESS         ABSOLUTE  FFC0 65472  startup
outport_img             LABEL     0166 358    .bss
outport_img_addr        LABEL     00C4 196    .text
outport_init            LABEL     00BA 186    .text
outport_write           LABEL     00CC 204    .text
positive                LABEL     0094 148    .text
PTC_ADDR                LABEL     0142 322    .text
ptc_addr_addr           LABEL     00D6 214    .text
PTC_ADDRESS             ABSOLUTE  FF78 65400  startup
PTC_CMD_START           ABSOLUTE  0000 0      startup
PTC_CMD_STOP            ABSOLUTE  0001 1      startup
ptc_init                LABEL     00F0 240    .text
ptc_start               LABEL     00D8 216    .text
ptc_stop                LABEL     00E4 228    .text
PTC_TC                  ABSOLUTE  0004 4      startup
PTC_TCR                 ABSOLUTE  0000 0      startup
PTC_TIR                 ABSOLUTE  0006 6      startup
PTC_TMR                 ABSOLUTE  0002 2      startup
reset                   LABEL     015A 346    .text
STACK_SIZE              ABSOLUTE  0040 64     startup
sysclk                  LABEL     0164 356    .bss
sysclk_addr             LABEL     0162 354    .text
SYSCLK_FREQ             ABSOLUTE  00F9 249    startup
sysclk_get_ticks        LABEL     0122 290    .text
time_measure            LABEL     005E 94     .text
tos                     LABEL     01A8 424    .stack
tos_addr                LABEL     0008 8      startup
user_break              LABEL     0144 324    .text
USER_MASk               ABSOLUTE  0001 1      startup

Code listing
   1          	    .equ INITIAL_OUTPORT, 0xFF
   2          	    .equ INITIAL_USER, 0x00
   3          	    .equ USER_MASk, 0x01
   4          	    .equ INPORT_ADDRESS, 0xFF80
   5          	    .equ OUTPORT_ADDRESS, 0xFFC0
   6          		.equ PTC_ADDRESS,  0xFF78          ; Endereco do circuito pTC
   7           	
   8          	    .equ PTC_TCR, 0                    ; Deslocamento do registo TCR do pTC
   9          		.equ PTC_TMR, 2                    ; Deslocamento do registo TMR do pTC
  10          		.equ PTC_TC,  4                    ; Deslocamento do registo TC do pTC
  11          		.equ PTC_TIR, 6                    ; Deslocamento do registo TIR do pTC
  12          		.equ PTC_CMD_START, 0              ; Comando para iniciar a contagem no pTC
  13          		.equ PTC_CMD_STOP, 1               ; Comando para parar a contagem no pTC
  14           	
  15          		.equ SYSCLK_FREQ, 249             ; Intervalo de contagem do circuito pTC
  16           	                                       ; que suporta a implementação do sysclk                          
  17          	    .equ STACK_SIZE, 64                ; Dimensao do stack - 64 B
  18          	    .equ	CPSR_BIT_I, 0b010000         
  19           	;----------------------------------------------------------------------------
  20           	
  21           		.section startup
  22 0000 01 58		b	_start
  23 0002 4F 0C		ldr	pc, isr_addr
  24           	_start:
  25 0004 1D 0C		ldr	sp, tos_addr
  26 0006 1F 0C		ldr	pc, main_addr
  27           	
  28           	tos_addr:
  29 0008 A8 01		.word	tos
  30           	main_addr:
  31 000A 0E 00		.word	main
  32           	isr_addr:
  33 000C 0C 01		.word	isr
  34           	
  35           	;---------------------------------------------------------------------------
  36           		.text
  37           	
  38           	main:
  39 000E 00 58		b init
  40           	
  41           	;r1 temp
  42           	init:
  43 0010 A4 5C	    bl reset
  44 0012 F0 6F	    mov r0, #INITIAL_OUTPORT
  45 0014 5B 5C	    bl outport_write
  46 0016 57 5C	    bl inport_read
  47 0018 11 60	    mov r1, #USER_MASk
  48 001A 80 C0	    and r0, r0, r1
  49 001C 80 B8	    cmp r0,r1 
  50 001E F8 43	    beq init ;1 bloco
  51           	
  52           	
  53           	check_USER:
  54 0020 52 5C	    bl inport_read 
  55 0022 11 60	    mov r1, #USER_MASk
  56 0024 80 C0	    and r0, r0, r1
  57 0026 80 B8	    cmp r0, r1 ;2 bloco
  58 0028 FB 47	    bne check_USER;transiçao para o terceiro
  59           	
  60           	;r2 Delay Time
  61           	delay_time:
  62 002A 10 60	    mov r0, #0x01
  63 002C 4F 5C	    bl outport_write
  64 002E 4B 5C	    bl inport_read 
  65 0030 00 EA	    lsr r0 , r0 , #4 
  66 0032 11 60	    mov r1 , #0x01
  67 0034 80 B8	    cmp r0 , r1
  68 0036 EC 4B	    blo init 
  69 0038 A1 60	    mov r1 , #0x0A
  70 003A 10 B8	    cmp r1, r0
  71 003C E9 4B	    blo init;3 bloco
  72 003E 8D 5C	    bl reset
  73 0040 00 24	    push r0
  74 0042 90 6F	    mov r0, #SYSCLK_FREQ
  75 0044 55 5C	    bl ptc_init
  76 0046 60 B0	    mrs	r0, cpsr
  77 0048 01 61		mov	r1, #CPSR_BIT_I
  78 004A 80 C8		orr	r0, r0, r1
  79 004C 40 B0		msr	cpsr, r0
  80 004E 00 04	    pop r0
  81 0050 6B 5C	    bl delay_before
  82 0052 00 60	    mov r0, #0x00
  83 0054 3B 5C	    bl outport_write
  84 0056 46 5C	    bl ptc_stop
  85 0058 80 5C	    bl reset
  86 005A 10 60	    mov r0, #1  ;tempo de execuçao do p16 das funçoes "time_measure" + "isr"
  87 005C 49 5C	    bl ptc_init
  88           	
  89           	time_measure:
  90           	   ; bl reset
  91 005E 33 5C	    bl inport_read
  92 0060 11 60	    mov r1, #0x01
  93 0062 80 C0	    and r0, r0 , r1
  94 0064 80 B8	    cmp r0, r1
  95 0066 FB 43	    beq time_measure
  96 0068 3D 5C	    bl ptc_stop
  97           	    
  98           	
  99           	fix_result:
 100 006A 5B 5C	    bl sysclk_get_ticks
 101 006C 91 68	    mov r1, #0x89 ; 137 ms
 102 006E 10 B8	    cmp r1, r0
 103 0070 1B 50	    bge out_of_range
 104 0072 71 60	    mov r1, #0x07 
 105 0074 11 70	    movt r1, #0x01; 263 ms
 106 0076 80 B8	    cmp r0, r1
 107 0078 17 50	    bge out_of_range
 108 007A 81 6C	    mov r1, #0xC8 ; 200 ms
 109 007C 80 B8	    cmp r0, r1
 110 007E 0A 50	    bge positive
 111           	
 112           	negative:
 113 0080 80 88	    sub r0, r0, r1
 114 0082 80 E0	    lsl r0, r0, #1 ;para colocar o1..o7
 115 0084 23 5C	    bl outport_write
 116 0086 2E 5C	    bl ptc_stop
 117 0088 68 5C	    bl reset
 118 008A 90 6F	    mov r0, #SYSCLK_FREQ
 119 008C 31 5C	    bl ptc_init
 120 008E 50 60	    mov r0, #5
 121 0090 52 5C	    bl delay_after
 122 0092 BE 5B	    b init
 123           	
 124           	positive:
 125 0094 80 88	    sub r0, r0 , r1
 126 0096 80 E0	    lsl r0, r0, #1 ;para colocar o1..o7
 127 0098 19 5C	    bl outport_write
 128 009A 24 5C	    bl ptc_stop
 129 009C 5E 5C	    bl reset
 130 009E 90 6F	    mov r0, #SYSCLK_FREQ
 131 00A0 27 5C	    bl ptc_init
 132 00A2 50 60	    mov r0, #5 
 133 00A4 48 5C	    bl delay_after
 134 00A6 B4 5B	    b init
 135           	
 136           	out_of_range:
 137 00A8 00 68	    mov r0, #0x80
 138 00AA 10 5C	    bl outport_write
 139 00AC 1B 5C	    bl ptc_stop
 140 00AE 55 5C	    bl reset
 141 00B0 90 6F	    mov r0, #SYSCLK_FREQ
 142 00B2 1E 5C	    bl ptc_init
 143 00B4 50 60	    mov r0, #5
 144 00B6 3F 5C	    bl delay_after
 145 00B8 AB 5B	    b init
 146           	
 147           	
 148           	
 149           	outport_init:
 150 00BA 0E 24		push	lr
 151 00BC 31 0C		ldr	r1, outport_img_addr
 152 00BE 10 28		strb	r0, [r1]
 153 00C0 05 5C		bl	outport_write
 154 00C2 0F 04		pop	pc
 155           	
 156           	outport_img_addr:
 157 00C4 66 01		.word	outport_img
 158           	
 159           	inport_read:
 160 00C6 61 0C		ldr	r1, inport_addr
 161 00C8 10 08		ldrb	r0, [r1, #0]
 162 00CA 0F B7		mov	pc, lr
 163           	
 164           	    
 165           	outport_write:
 166 00CC 21 0C		ldr	r1, outport_addr
 167 00CE 10 28		strb	r0, [r1, #0]
 168 00D0 0F B7		mov	pc, lr
 169           	
 170           	outport_addr:
 171 00D2 C0 FF	    .word OUTPORT_ADDRESS
 172           	
 173           	
 174           	inport_addr:
 175 00D4 80 FF	    .word INPORT_ADDRESS
 176           	
 177           	ptc_addr_addr:
 178 00D6 42 01	    .word PTC_ADDR
 179           	
 180           	
 181           	
 182           	ptc_start:
 183 00D8 00 24	    push r0
 184 00DA 30 0F		ldr	r0, PTC_ADDR
 185 00DC 01 60		mov	r1, #PTC_CMD_START
 186 00DE 01 28		strb r1, [r0, #PTC_TCR]
 187 00E0 00 04	    pop r0
 188 00E2 0F B7		mov	pc, lr
 189           	
 190           	ptc_stop:
 191 00E4 00 24	    push r0
 192 00E6 D0 0E		ldr	r0, PTC_ADDR
 193 00E8 11 60		mov	r1, #PTC_CMD_STOP
 194 00EA 01 28		strb r1, [r0, #PTC_TCR]
 195 00EC 00 04	    pop r0
 196 00EE 0F B7		mov	pc, lr
 197           	
 198           	ptc_init:
 199 00F0 0E 24		push lr
 200 00F2 00 24	    push r0
 201 00F4 04 24	    push r4
 202 00F6 05 24		push r5
 203 00F8 05 B0		mov r5, r0
 204 00FA F4 5F	    bl ptc_stop
 205 00FC 24 0E		ldr r4, PTC_ADDR
 206 00FE 45 29		strb r5, [r4, #PTC_TMR]
 207 0100 45 2B	    strb     r5, [r4, #PTC_TIR] ; limpar PTC TIR
 208 0102 EA 5F	    bl ptc_start
 209 0104 05 04		pop r5
 210 0106 04 04		pop r4
 211 0108 00 04	    pop r0
 212 010A 0F 04	    pop pc
 213           	
 214           	isr:
 215 010C 00 24	 	push    r0
 216 010E 01 24	    push    r1
 217           	    ; limpar PTC TIR
 218 0110 80 0D	    ldr r0, PTC_ADDR
 219 0112 00 2B	    strb r0, [r0, #PTC_TIR]
 220 0114 60 0E	    ldr    r0, sysclk_addr
 221 0116 01 00	    ldr    r1, [r0, #0]
 222 0118 91 A0	    add    r1, r1, #1
 223 011A 01 20	    str    r1, [r0, #0]
 224 011C 01 04	    pop    r1
 225 011E 00 04	    pop    r0
 226 0120 20 B0	    movs    pc, lr
 227           	
 228           	sysclk_get_ticks:
 229 0122 F0 0D		ldr    r0, sysclk_addr
 230 0124 00 00	    ldr    r0, [r0, #0]
 231 0126 0F B7	    mov    pc, lr
 232           	
 233           	delay_before:
 234 0128 0E 24	    push lr
 235 012A 01 E1	    lsl r1, r0, #2
 236           	delay_loop_before:
 237 012C 0B 5C	    bl user_break
 238 012E F9 5F	   bl sysclk_get_ticks
 239 0130 10 B8	   cmp r1, r0
 240 0132 FC 47	   bne delay_loop_before
 241           	delay_end_before:
 242 0134 0F 04	    pop pc
 243           	
 244           	delay_after:
 245 0136 0E 24	    push lr
 246 0138 01 E1	    lsl r1, r0, #2
 247           	delay_loop_after:
 248 013A F3 5F	   bl sysclk_get_ticks
 249 013C 10 B8	   cmp r1, r0
 250 013E FD 47	   bne delay_loop_after
 251           	delay_end_after:
 252 0140 0F 04	    pop pc
 253           	
 254           	PTC_ADDR:
 255 0142 78 FF	    .word    PTC_ADDRESS
 256           	
 257           	user_break:
 258 0144 0E 24	    push lr
 259 0146 01 24	    push r1
 260 0148 00 24	    push r0
 261 014A BD 5F	    bl inport_read
 262 014C 11 60	    mov r1, #USER_MASk
 263 014E 80 C0	    and r0, r0, r1
 264 0150 80 B8	    cmp r0,r1
 265 0152 5E 47	    bne init
 266 0154 00 04	    pop r0
 267 0156 01 04	    pop r1
 268 0158 0F 04	    pop pc
 269           	
 270           	reset:
 271 015A 31 0C	    ldr r1, sysclk_addr
 272 015C 02 60	    mov r2, #0
 273 015E 12 20	    str r2,[r1]
 274 0160 0F B7	    mov pc, lr
 275           	
 276           	sysclk_addr:
 277 0162 64 01	    .word sysclk
 278           	
 279           	
 280           	
 281           	;----------------------------------------------------------------------------
 282           	
 283           	    .data
 284           	
 285           	;----------------------------------------------------------------------------    
 286           	
 287           	    .bss
 288           	sysclk:
 289 0164 00   		.space	2
 289 0165 00
 290           	outport_img:
 291 0166 00   		.space	1
 292 0167 00  		.align
 293           	;----------------------------------------------------------------------------
 294           	
 295           	    .stack
 296 0168 00   	    .space STACK_SIZE
 296 .... ..
 296 01A7 00
 297           	tos:
